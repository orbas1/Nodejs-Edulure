# Backend Change Log â€“ Version 1.50 Task 1

- Introduced a production security baseline for the Express API (rate limiting, strict CORS, Helmet/HPP, compression, structured logging, env validation).
- Standardised API contracts with shared response helpers, Joi validation coverage, role-aware auth middleware, and Swagger/OpenAPI documentation.
- Migrated persistence management to Knex with transactional orchestration services, refresh-token session storage, and domain event logging.
- Replaced legacy SQL installers with programmatic provisioning scripts, `.nvmrc`/`.npmrc` runtime pinning, the preinstall verifier, and Dependabot configuration for dependency governance.
- Added Cloudflare R2 integration, StorageService abstraction, and StorageService-based presigning helpers to manage uploads/downloads.
- Introduced an AntivirusService with ClamAV streaming scans, Prometheus telemetry, quarantine workflows, and admin-facing audit trails so malicious uploads are blocked and retained for review.
- Landed a production observability stack with request correlation IDs, redaction-aware structured logging, Prometheus `/metrics`, and R2 instrumentation feeding storage latency/throughput dashboards and alerting runbooks.
- Implemented AssetService/AssetIngestionService lifecycles with CloudConvert conversions, EPUB manifest normalisation, DRM enforcement, and analytics logging.
- Extended controllers/routes/OpenAPI spec for `/api/content` endpoints covering uploads, ingestion, viewer tokens, analytics, telemetry, and progress.
- Added a dedicated CourseService stack: Knex migrations for courses/modules/lessons/assignments, domain models, Express controllers/routes under `/api/courses`, drip gating logic with progress aggregation, assignment due-date computation, and Prometheus counters for drip evaluations/progress updates with Vitest coverage.
- Built a full ebook domain: migrations for ebooks/chapters/highlights/bookmarks/reader settings/watermark events, domain models and an `EbookService` handling manifest synchronisation, sanitised chapter storage, DRM-enforced download issuance, metrics instrumentation, seeded reference data, and an Express controller/route suite exposed through `/api/ebooks` with comprehensive OpenAPI coverage.
- Delivered tutor hire and live classroom services: migration `20241118103000_live_classroom_and_tutor_hire.js`, new models, `TutorService` and `LiveClassroomService` orchestrating availability validation, booking conflicts, seat limits, Agora token generation, registration gating, Prometheus instrumentation, seeded datasets, controllers/routes for `/api/tutors` and `/api/live-classrooms`, and OpenAPI schemas for scheduling, booking, registration, chat, and join workflows.
- Bootstrapped database schema for content assets, ingestion jobs, conversion outputs, audit logs, events, and ebook progress tracking.
- Added a Vitest suite and environment harness to validate StorageService bucket resolution, presigning TTLs, and CDN URL generation without Cloudflare dependencies.
- Implemented a JWT key store with active/fallback key support, added a secure rotation script, and wired middleware/services to honour issuer/audience enforcement with key identifiers.
- Delivered credential lockout governance by extending the `users` table with failure telemetry, enforcing rolling lockout windows, and emitting audit domain events for successes, failures, and lock states.
- Shipped email verification flows with hashed token storage, SMTP delivery, OpenAPI-documented endpoints, and controller/service orchestration that blocks unverified logins while providing throttled resend support.
- Delivered full-session governance with hashed refresh token storage, JWT `sid` claims, cached session validation, forced logout APIs (`/api/auth/refresh`, `/logout`, `/logout-all`), OpenAPI schemas, and audit/domain events so compromised credentials can be revoked instantly.
- Hardened configuration governance by expanding environment validation for SMTP and lockout controls, bundling operational defaults in `.env.example`, and covering the new mailer contract with Vitest.
- Operationalised data hygiene: added retention policy/audit tables, community owner triggers, production-grade seed data, and a retention enforcement service + CLI that purges stale sessions/telemetry while emitting immutable audit records.
- Hardened the retention programme with a managed `node-cron` scheduler, backoff-aware failure handling, environment toggles, and Vitest coverage for both the retention executor and job lifecycle.
- Delivered a database-backed feature flag and runtime configuration service with caching, Prometheus metrics, `/api/runtime` endpoints, an operational CLI, and React integration so staged rollouts and kill switches are centrally governed.
- Migrated backend linting to ESLint's flat config with workspace-wide scripts, expanded Prometheus test doubles, and stabilised the feature flag/runtime configuration suites so governance automation ships with green quality gates.
- Delivered the payments commerce stack: migrations/models for payment intents, coupons, refunds, and ledger entries; PaymentService orchestrating Stripe intents, PayPal captures/refunds, coupon lifecycle, finance summaries, and Prometheus metrics; PaymentController/routes with Stripe raw-body middleware, updated OpenAPI paths/schemas, environment validation/README guidance, and Vitest suites covering tax allocation, refund idempotency, and webhook handling.
- Finalised community engagement mechanics: introduced migration `20241120130000_community_engagement.js`, repositories for member points, point transactions, streaks, events, event participants, and reminders, a `CommunityEngagementService` that awards points, manages streak rollovers, computes tier leaderboards, hydrates map-ready event calendars, and schedules reminders, plus controller/route wiring, OpenAPI schemas, Vitest suites, and the cron-friendly `CommunityReminderJob` with Prometheus counters to keep engagement automation observable.
- Delivered the communities chat and direct messaging stack: migration `20241123100000_community_chat.js` establishes channel/member/message/reaction/moderation tables alongside DM threads/messages/participants and user presence tracking; new models power `CommunityChatService` and `DirectMessageService`, Express controllers/routes expose channel timelines, threaded replies, reactions, moderation, presence, and DM inbox workflows, OpenAPI coverage documents every endpoint and schema, production seeds hydrate realistic conversations, and new Vitest suites (service + HTTP integration) validate happy paths and Joi validation/error handling.
- Launched the social graph platform: migration `20241125140000_social_graph.js` introduces privacy, follow, mute, block, recommendation, and audit tables; models encapsulate each store; `SocialGraphService` orchestrates approvals, blocks, mutes, recommendations, and privacy updates with domain events + audit logging; `SocialGraphController`/routes under `/api/social` expose follower/following lists, follow/unfollow, approvals, mutes, blocks, and privacy APIs; OpenAPI schemas document requests/responses; seeds add realistic relationships; README and environment validation cover new tuning knobs; Vitest service + HTTP suites verify pagination, approvals, blocks, and recommendation flows.
- Hardened social graph operations with transaction-safe helper execution that logs and tolerates follow recommendation clean-up/mute-unmute exceptions, removing silent promise catches so failures surface through structured warnings while preserving customer actions.
- Normalised OpenAPI nullable fields (replacing `type: ["string", "null"]` patterns with `nullable` flags) and validated the full specification via `swagger-cli validate src/docs/openapi.json` to guarantee schema compatibility for chat, DM, and social graph contracts.
- Delivered the Meilisearch explorer foundation: introduced environment validation for host lists/credentials, `SearchClusterService`
  provisioning seven explorer indexes with ranking rules, synonyms, filterable/sortable attributes, typo-tolerance, and
  pagination/faceting limits, enforced read-only search keys at boot, exposed new Prometheus gauges for node health/index status,
  added `npm run search:provision` for bootstrap + snapshot automation, and documented cluster configuration in the backend README.
- Added explorer ingestion pipelines: `SearchIngestionService` batches and parallelises ETL for communities, courses, ebooks, tutors, profiles, ads, and events with incremental `since` cursors, delete-before-reindex safeguards, and Prometheus instrumentation. A dedicated `npm run search:reindex` CLI drives full/delta syncs, new migrations seed curriculum/tutor/live classroom/ads intelligence tables, `.env.example` surfaces ingestion tuning knobs, and Vitest coverage protects loader pagination/error telemetry so Meilisearch stays aligned with PostgreSQL.
- Implemented the Explorer delivery APIs: new `saved_searches` migration, model, and `SavedSearchService`, `ExplorerSearchService` federation layer, `ExplorerController`, and `explorer.routes.js` expose `/api/explorer/search` plus CRUD for `/api/explorer/saved-searches`. Responses normalise Meilisearch hits, facets, geo markers, and pagination metadata while Prometheus search timings feed existing dashboards. Seeds hydrate exemplar saved searches, OpenAPI paths/schemas document the contracts, and README/env guidance covers search key requirements.
- Finalised the ads intelligence service layer: `AdsService` now auto-halts overspending campaigns, syncs compliance metadata, calculates performance scores with chronological insight ordering, emits domain events for auto-pauses, and exposes Vitest suites for compliance/insight flows alongside HTTP route coverage ensuring instructor dashboards stay in lockstep with backend governance.
- Introduced the dashboards/profile aggregation stack: `ProfileRepository` unifies user, social, community, programme, and commerce lookups with privacy-aware joins, while `ProfileAggregationService` composes hero metrics, badge collections, quick actions, programme shelves, insights, and timeline events with Redis-backed TTL caching and structured fallback logging so downstream clients receive resilient payloads even when dependent services degrade.
- Extended Express with `ProfileController` + `profile.routes.js` to expose `GET /api/profiles/:id/overview`, wired cache-busting headers, and integrated Joi validation plus audit logging. `src/app.js` registers the route and the OpenAPI specification documents hero/badge/shelf/insight/timeline schemas to keep frontend/mobile teams contract-aligned.
- Added Vitest coverage for profile aggregation (`test/profileAggregationService.test.js`, `test/profileHttpRoutes.test.js`) exercising cache priming, stale eviction, and HTTP 404/403 paths, closing Task 5.1 readiness gaps before dashboards expand beyond the profile experience.
