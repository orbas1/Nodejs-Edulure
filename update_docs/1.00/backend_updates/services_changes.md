# Service Changes

- `AuthService` issues signed access tokens with issuer/audience claims, persists hashed refresh tokens in `user_sessions`, records registration events for auditing, and now signs tokens using the shared key store with `kid` metadata for rotation.
- `CommunityService` orchestrates community creation with slug collision detection, automatic owner enrolment, metadata storage, and domain event emission.
- `UserService` proxies the new repository helpers, ensuring consistent pagination metadata.
- `StorageService` provides presigned upload/download helpers, direct buffer uploads, public URL builders, and object lifecycle utilities on top of the Cloudflare R2 client, and is now exported for isolated testing.
- Introduced `AntivirusService` to stream files through ClamAV, enforce cacheable clean results, quarantine infected artefacts, and emit Prometheus metrics consumed by observability dashboards.
- `StorageService` now exposes `getObjectStream` so antivirus and ingestion routines can consume R2 objects via streams without loading entire payloads into memory.
- `AssetService` manages content asset lifecycle (upload session creation, ingestion confirmation, analytics, DRM enforcement) while emitting audit logs and telemetry events, now using a dedicated DRM signature secret surfaced by the environment configuration and executing antivirus/quarantine workflows before assets progress to ingestion.
- `AssetIngestionService` polls for pending jobs, integrates with CloudConvert, normalises EPUB manifests, and updates asset metadata/status with error handling.
- `AuthService` now orchestrates account lockouts and verification gating: failed logins increment rolling counters, lockouts emit domain events, and unverified users trigger token issuance instead of session creation. Session lifecycle governance adds refresh rotation, revocation/audit events, concurrent-session limits, cached validation, and logout-all tooling documented in OpenAPI.
- Introduced `EmailVerificationService` to issue hashed tokens, enforce resend cooldowns, and mark verification completion transactionally with audit logging.
- Added `MailService` as the SMTP abstraction used by verification flows, rendering production-grade HTML/text templates and logging dispatch identifiers for observability.
- `StorageService` now wraps Cloudflare R2 calls in telemetry spans and Prometheus counters/histograms, exposing payload size, latency, and in-flight gauges for observability dashboards.
- Introduced `DataRetentionService` to read policy metadata, enforce hard/soft delete actions per entity, and log immutable audit rows; scriptable via the new `npm run data:retention` CLI for scheduled hygiene sweeps.
- Added `DataRetentionJob` to coordinate cron scheduling, dry-run bootstraps, and failure backoff, wiring the retention executor directly into the API lifecycle so hygiene enforcement runs continuously without human intervention.
- Introduced `FeatureFlagService` and `RuntimeConfigService` to cache flag definitions, evaluate percentage/segment rollouts, surface runtime configuration payloads via `/api/runtime`, expose Prometheus counters, and support an operational CLI for governance teams; the services now alias test environments to development for gating and honour private config exposure with internal audiences.
- Introduced `CourseService` to orchestrate course/module/lesson/assignment lifecycles with Knex-backed repositories, transactional authoring flows, drip schedule evaluation, progress aggregation, assignment scoring, domain event emission, and Prometheus metrics for drip and progress instrumentation.
- Introduced `EbookService` to manage the end-to-end ebook programme: manifest synchronisation, sanitised chapter storage, highlight/bookmark orchestration, reader preference persistence, DRM download token issuance with watermark auditing, Prometheus counters for downloads/highlights/bookmarks/preferences, and transactional integration with `AssetService`/`AssetIngestionService` for secure ingestion.
- Introduced `TutorService` handling tutor profile CRUD, availability window validation, conflict detection, booking orchestration with transactional seat holds, payout preparation hooks, and Prometheus counters/summary metrics for accepted, cancelled, and hours-booked volumes alongside domain event emission for downstream notifications.
- Added `LiveClassroomService` to coordinate classroom scheduling, seat limit enforcement, registration/ticket validation, Agora join token issuance via the shared token helper, chat session initialisation, Prometheus gauges for seat utilisation/active sessions, and event logging for lifecycle transitions.
- Added `agoraToken` utility to wrap Agora Access Token generation with deterministic salts, TTL validation, and logging to avoid circular dependencies between services/controllers when issuing join credentials.
- Introduced `PaymentService` handling Stripe intent creation, PayPal order capture, coupon eligibility, tax/discount allocation, ledger entry emission, refund orchestration, Stripe webhook processing, and finance summary reporting with Prometheus metrics and Vitest coverage for percentage caps, partial refunds, PayPal idempotency, and webhook signature validation.
- Added `CommunityEngagementService` to orchestrate member points, streak rollovers, leaderboard snapshots, map-ready event calendars, RSVP guardrails, and reminder scheduling, emitting domain events for analytics and powering the cron-backed reminder job with configurable batching, lookahead, and timezone support.
- Introduced `CommunityChatService` and `DirectMessageService` handling channel access enforcement, threaded message creation, reactions, moderation, read receipts, presence upserts, DM thread reuse/creation, message previews, and domain event emission with transactional guarantees and Prometheus instrumentation for messaging workloads.
- Added `SocialGraphService` to orchestrate the follow graph: validates privacy and block constraints, manages follow/unfollow and approval flows, applies mutes/blocks with cascading follow cleanup, surfaces follower/following pagination with viewer context, generates recommendation fallbacks when cached suggestions are exhausted, records social audit logs, and emits domain events for approvals, removals, blocks, and privacy updates.
- Introduced `SearchClusterService` to manage the Meilisearch explorer cluster: bootstraps and validates index definitions, audits API key privileges to enforce read-only search keys, runs continuous health checks with Prometheus gauges, provides snapshot automation, and exposes helper accessors for admin/read clients used by downstream indexing workers.
- Introduced `SearchIngestionService` to orchestrate batched, concurrent ETL into Meilisearch: streams communities/courses/ebooks/tutors/profiles/ads/events documents with incremental `since` cursors, delete-before-reindex toggles, snapshot-aware batching, and Prometheus instrumentation while reusing `SearchClusterService` for safe client lifecycle management.
- Added `ExplorerSearchService` to federate Meilisearch queries across explorer indexes, apply facet-aware filter construction, normalise result summaries, attach geo markers via the new country centroid catalogue, and expose Prometheus search timings for dashboards; introduced `SavedSearchService` to persist user-defined explorer searches with transactional name conflict checks, pinning, and usage telemetry.
- `AdsService` enforces compliance automation by auto-pausing overspending campaigns, recording domain events, computing performance scores, and returning chronologically ordered insight series; Vitest suites exercise compliance and analytics flows while HTTP route coverage validates instructor dashboards end-to-end.
- Introduced `ProfileAggregationService` to compose hero metrics, verification badges, engagement insights, programme/community shelves, quick actions, and timeline events for a given user. The service hydrates from repositories spanning profiles, communities, social graph, payments, and content domains, applies privacy/role gating, batches lookups to reduce query load, caches results with Redis-backed TTL governance, and exposes cache-busting helpers used by controllers and upcoming dashboard jobs.
- `DashboardService` now enriches learner payloads with notifications, follower governance, financial, and settings data while normalising recommendation/user identifiers for the React dashboard. `DirectMessageService` gained `updateNotificationPreference`, calling the participant repository helper to apply global notification toggles and returning operational metrics for the dashboard.
- `DashboardService` finalised the instructor aggregation path: the revived `buildInstructorDashboard` helper composes instructor course/lesson/assignment analytics, tutor availability and booking pipelines, live classroom calendars, asset/ebook performance, community monetisation, ad experiments, and subscription revenue; `getDashboardForUser` now merges the instructor payload alongside learner data, expands role listings/search index entries, and reworks profile stats/bio assembly so dashboards and profile tiles stay in sync.
- Introduced `AdminConsoleService` to hydrate the operational snapshot consumed by `/api/admin/console`. The service composes subscription and community growth deltas, CSAT/response-time metrics, refund backlog totals, approval queues, active incidents, policy review schedules, and support ticket backlogs in a single transaction-safe payload, reusing new repositories (`SupportTicketModel`, `SupportTicketEventModel`, `IncidentReportModel`, `AdminReviewRequestModel`, `PolicyDocumentModel`) and finance queries. Helpers normalise time windows, compute percentage deltas, and expose backlog wait-state derivations so the React admin console renders production analytics without post-processing.
